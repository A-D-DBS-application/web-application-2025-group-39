{% extends "base.html" %}

{% block title %}Add New Feature{% endblock %}
{% block body_class %}features-body{% endblock %}

{% block content %}
  <!-- Right-top button -->
  <div class="top-right">
    <a href="{{ url_for('main.vectr_chart', project_id=project.id_project) }}" 
      class="btn btn-base btn-sm btn-vectr me-2">
      ðŸ“ˆ VECTR Chart
    </a>

    <a href="{{ url_for('main.projects') }}" 
      class="btn btn-base btn-nav btn-sm">
      Go to Projects
    </a>
  </div>

  <h2 class="text-center mb-4">Add New Feature</h2>

  <div class="feature-form card shadow p-4 mx-auto">
    <form method="post" action="{{ url_for('main.add_feature', project_id=project.id_project) }}">
      <!-- BASIC INFO -->
      <div class="mb-4">
        <h4 class="mb-3">Basic Info</h4>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" name="name_feature" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Project</label>
            <input type="text" class="form-control" value="{{ project.project_name }}" disabled>
            <input type="hidden" name="id_project" value="{{ project.id_project }}">
            <input type="hidden" name="id_company" value="{{ company.id_company }}">
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label">Description</label>
          <textarea class="form-control" name="description" rows="3"></textarea>
        </div>
      </div>

      <!-- ROI -->
      <div class="mb-4">
        <h4 class="mb-3">Return on Investment (ROI)</h4>
        <p class="text-muted fst-italic mb-2">
          <strong>Total Gains =</strong> revenue + churn + cost savings<br>
          <strong>Total Costs =</strong> development + OPEX + other
        </p>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">
              Horizon (months) 
              <!--aanmaken van het i icoontje -->
              <i class="bi bi-info-circle" data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-placement="top" 
                data-bs-content="The time window over which expected revenue, churn reduction and cost savings are estimated.">
              </i>
            </label>
            <input type="number" class="form-control" name="horizon" min="0">
          </div>
          <div class="col-md-6">
            <label class="form-label">
              Extra Revenue
              <i class="bi bi-info-circle" data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-placement="top" 
                data-bs-content="Estimated additional revenue over horizon H caused by this feature. Use realistic benchmarks or past release data.">
              </i>
            </label>
            <input type="number" class="form-control" name="extra_revenue" min="0">
          </div>
          <div class="col-md-6">
            <label class="form-label">
              Churn Reduction Savings
              <i class="bi bi-info-circle" data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-placement="top" 
                data-bs-content="Estimated savings due to lower churn over horizon H. Use customer lifetime value or retention metrics if available.">
              </i>
            </label>
            <input type="number" class="form-control" name="churn_reduction" min="0">
          </div>
          <div class="col-md-6">
            <label class="form-label">
              Cost Savings
              <i class="bi bi-info-circle" data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-placement="top" 
                data-bs-content="Direct cost reductions caused by this feature. Examples include: lower support load, automation, reduced operational overhead.">
              </i>
            </label>
            <input type="number" class="form-control" name="cost_savings" min="0">
          </div>
        </div>
        <h5 class="mt-4">Investment Cost</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">
              Development Effort (hours)
              <i class="bi bi-info-circle" data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-placement="top" 
                data-bs-content="Estimated implementation effort expressed in hours or person-days. Used to calculate investment cost. Keep it realistic and comparable.">
              </i>
            </label>
            <input type="number" class="form-control" name="investment_hours" min="0">
          </div>
          <div class="col-md-6">
            <label class="form-label">
              OPEX (operational costs)
              <i class="bi bi-info-circle" data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-placement="top" 
                data-bs-content="Operational costs: hosting, subscriptions, monitoring, maintenance. Include only the incremental costs caused by this feature.">
              </i>
            </label>
            <input type="number" class="form-control" name="opex_hours" min="0">
          </div>
          <div class="col-md-12">
            <label class="form-label">
              Other Costs (optional)
              <i class="bi bi-info-circle" data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-placement="top" 
                data-bs-content="Optional category for licensing, integration or opportunity cost that does not fit other fields.">
              </i>
            </label>
            <input type="number" class="form-control" name="other_costs" min="0">
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label">
            ROI (%)
            <i class="bi bi-info-circle" data-bs-toggle="popover" 
              data-bs-trigger="hover focus" 
              data-bs-placement="top" 
              data-bs-content="ROI = ((Total Gains - Total Costs) / Total Costs) Ã— 100. Displayed as a percentage and used to determine bubble size in VECTR.">
            </i>
          </label>
          <input type="text" class="form-control" name="roi_percent" placeholder="Calculated automatically" readonly>
        </div>
      </div>

      <!-- TTV -->
      <div class="mb-4">
        <h4 class="mb-3">Time to Value (TTV)</h4>
        <p class="text-muted fst-italic">TTV = Time-to-Market + Time-to-Business-Value</p>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">
              Time-to-Market (weeks)
              <i class="bi bi-info-circle" data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-placement="top" 
                data-bs-content="Time-to-Market: The time (in weeks) required to build and release the first working version. Includes design, development, testing and deployment.">
              </i>
            </label>
            <input type="number" class="form-control" name="ttm_weeks" min="0">
          </div>
          <div class="col-md-6">
            <label class="form-label">
              Time-to-Business-Value (weeks)
              <i class="bi bi-info-circle" data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-placement="top" 
                data-bs-content="Time-to-Business-Value: The time (in weeks) required after launch, before measurable business value appears. Example: first paying customers, KPI improvement, adoption.">
              </i>
            </label>
            <input type="number" class="form-control" name="ttbv_weeks" min="0">
          </div>
          <div class="col-12">
            <label class="form-label">TTV (weeks)</label>
            <input type="text" class="form-control" name="ttv_weeks" placeholder="Calculated automatically" readonly>
          </div>
        </div>
      </div>

      <!-- CONFIDENCE -->
      <div class="mb-4">
        <h4 class="mb-3">Evidence & Confidence Level</h4>
        <label class="form-label mb-2">
            Confidence Score
            <i class="bi bi-info-circle" 
                data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-html="true"
                data-bs-placement="top" 
                data-bs-content="Confidence is based on the strongest available evidence. Score range: 0.01 (very weak) &rarr; 10 (strong launch data). Used for the X-axis position in the VECTR graph.">
            </i>
        </label>
        <select class="form-select" name="quality_score" required>
          <option value="">Select score</option>
          <option value="0.01">Self Conviction â€” 0.01</option>
          <option value="0.03">Pitch Deck â€” 0.03</option>
          <option value="0.1">Thematic Support â€” 0.1</option>
          <option value="0.2">Otherâ€™s Opinion â€” 0.2</option>
          <option value="0.5">Estimates & Plans â€” 0.5</option>
          <option value="1">Anecdotal Evidence â€” 1.0</option>
          <option value="2">Market Data â€” 2.0</option>
          <option value="3">User/Customer Evidence â€” 3.0</option>
          <option value="7">Test Results â€” 7.0</option>
          <option value="10">Launch Data â€” 10.0</option>
        </select>
      </div>

      <div class="text-end">
        <button class="btn btn-primary">Save Feature</button>
      </div>
    </form>
  </div>

<script>
  // Initialiseer alle Popovers op de pagina
  document.addEventListener('DOMContentLoaded', function () {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      // Gebruik de 'html: true' optie als je HTML in de Popover content wilt, maar hier niet nodig
      return new bootstrap.Popover(popoverTriggerEl)
    })
  });
</script>

  <!--Verwijzing naar berekening ROI en TtV in js-bestand-->
<script src="{{ url_for('static', filename='js/feature_calculations.js') }}"></script>
{% endblock %}
