{% extends "base.html" %}

{% block title %}Add New Feature{% endblock %}
{% block body_class %}features-body{% endblock %}

{% block content %}

<!-- Knop rechtsboven om naar de VECTR-grafiek te gaan -->
<div class="top-right">
  <a href="{{ url_for('main.vectr_chart', project_id=project.id_project) }}" class="btn btn-base btn-nav btn-sm">
    ðŸ“ˆ VECTR Chart
  </a>
</div>

<h2 class="text-center mb-4">Add New Feature</h2>

<!-- Hoofdformulier voor het toevoegen van een nieuwe feature -->
<div class="feature-form card shadow p-4 mx-auto">
  <form method="post" action="{{ url_for('main.add_feature', project_id=project.id_project) }}">

    <!-- BASIC INFO sectie: titel, project en beschrijving -->
    <div class="mb-4">
      <h4 class="mb-3">Basic Info</h4>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Title</label>
          <input type="text" class="form-control" name="name_feature" required>
        </div>

        <!-- Projectnaam tonen, IDs in hidden fields doorgeven -->
        <div class="col-md-6">
          <label class="form-label">Project</label>
          <input type="text" class="form-control" value="{{ project.project_name }}" disabled>
          <input type="hidden" name="id_project" value="{{ project.id_project }}">
          <input type="hidden" name="id_company" value="{{ company.id_company }}">
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">Description</label>
        <textarea class="form-control" name="description" rows="3"></textarea>
      </div>
    </div>


    <!-- ROI sectie: velden voor financiÃ«le baten en kosten -->
    <div class="mb-4">
      <h4 class="mb-3">Return on Investment (ROI)</h4>

      <p class="text-muted fst-italic mb-2">
        <strong>Total Gains =</strong> revenue + churn + cost savings<br>
        <strong>Total Costs =</strong> development + OPEX + other
      </p>

      <div class="row g-3">

        <!-- Horizon (maanden) â€” bepaalt hoe lang vooruit de ROI berekend wordt -->
        <div class="col-md-6">
          <label class="form-label">
            Horizon (months)
            <!--aanmaken van het i icoontje -->
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="The number of months we look ahead to estimate the impact of this feature. During this period, we calculate expected revenue, churn reduction, and cost savings.">
            </i>
          </label>
          <input type="number" class="form-control" name="horizon" min="0">
        </div>
        <!-- Extra inkomsten -->
        <div class="col-md-6">
          <label class="form-label">
            Extra Revenue
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="The additional money this feature is expected to bring in during the selected time period. Use realistic estimates based on benchmarks or results from previous releases.">
            </i>
          </label>
          <input type="number" class="form-control" name="extra_revenue" min="0">
        </div>

        <!-- Geld bespaard door minder churn -->
        <div class="col-md-6">
          <label class="form-label">            Churn Reduction Savings
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="The amount of money saved because fewer customers leave. If possible, use metrics like customer lifetime value or retention rates to estimate this.">
            </i>
          </label>
          <input type="number" class="form-control" name="churn_reduction" min="0">
        </div>

        <!-- Kostenbesparing door het feature -->
        <div class="col-md-6">
          <label class="form-label">            Cost Savings
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="The direct costs that go down thanks to this feature. Examples include fewer support tickets, automation that replaces manual work, or lower operational overhead.">
            </i>
          </label>
          <input type="number" class="form-control" name="cost_savings" min="0">
        </div>
      </div>

      <h5 class="mt-4">Investment Cost</h5>

      <div class="row g-3">

        <!-- Development effort (uren) -->
        <div class="col-md-6">
          <label class="form-label">
            Development Effort (hours)
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="How much time the team needs to build this feature, expressed in hours or person-days. This number is used to calculate the investment cost â€” keep it honest and consistent.">
            </i>
          </label>
          <input type="number" class="form-control" name="investment_hours" min="0">
        </div>

        <!-- Uurtarief -->
        <div class="col-md-6">
          <label class="form-label">            
            Cost per Hour (â‚¬)
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="The hourly cost of development. This can be internal cost or external billing rate.">
            </i>
          </label>
          <input type="number" class="form-control" name="hourly_rate" min="0">
        </div>

        <!-- Operationele kosten -->
        <div class="col-md-6">
          <label class="form-label">
            OPEX (operational costs)
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="The ongoing costs required after the feature is launched. This could be hosting, subscriptions, monitoring, or maintenance. Only include the extra costs specifically caused by this feature.">
            </i>
          </label>
          <input type="number" class="form-control" name="opex_hours" min="0">
        </div>

        <!-- Andere kosten -->
        <div class="col-md-6">
          <label class="form-label">
            Other Costs (optional)
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="A category for any costs that do not fit elsewhere.This could include licensing fees, integration costs or opportunity costs.">
            </i>
          </label>
          <input type="number" class="form-control" name="other_costs" min="0">
        </div>
      </div>

      <!-- ROI-resultaten worden dynamisch geladen via partial -->
      <div id="roi-results">
        {% include "features/_roi_partial.html" %}
      </div>
    </div>



    <!-- TTV: Time to Value (Time-to-Market + Time-to-Business-Value) --> 
    <div class="mb-4">
      <h4 class="mb-3">Time to Value (TTV)</h4>

      <div class="row g-3">
        <!-- Linker kolom: alle Time-to-Market velden -->
        <div class="col-md-6">

          <!-- Minimale schatting van de tijd om te bouwen -->
          <label class="form-label">Lowest Time-to-Market
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="Provide your best estimate of the minimum number of weeks required to build and release the feature. This will later be used to scale the graph correctly.">
            </i>
          </label>
          <input type="number" class="form-control" name="ttm_low" min="0">

          <!-- Maximale schatting van de tijd om te bouwen -->
          <label class="form-label mt-3">Highest Time-to-Market
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="Provide your best estimate of the maximum number of weeks required to build and release the feature. This will later be used to scale the graph correctly.">
            </i>
          </label>
          <input type="number" class="form-control" name="ttm_high" min="0">

          <!-- Verwachte Time-to-Market waarde (in weken) -->
          <label class="form-label mt-3">Time-to-Market (weeks)
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="The number of weeks needed to build and release the first usable version of the feature. This includes everything: design, development, testing and deployment.">
            </i>
          </label>
          <input type="number" class="form-control" name="ttm_weeks" min="0">
        </div>

        <!-- Rechter kolom: alle Time-to-Business-Value velden -->
        <div class="col-md-6">

          <!-- Minimale tijd tot eerste business value -->
          <label class="form-label">Lowest Time-to-Business-Value
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="Provide your best estimate of the minimum number of weeks after launch before the feature begins delivering measurable business value. This will later be used to scale the graph correctly.">
            </i>
          </label>
          <input type="number" class="form-control" name="ttbv_low" min="0">

          <!-- Maximale tijd tot eerste business value -->
          <label class="form-label mt-3">Highest Time-to-Business-Value
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="Provide your best estimate of the maximum number of weeks after launch before the feature begins delivering measurable business value. This will later be used to scale the graph correctly.">
            </i>
          </label>
          <input type="number" class="form-control" name="ttbv_high" min="0">

          <!-- Verwachte Time-to-Business-Value waarde (in weken) -->
          <label class="form-label mt-3">Time-to-Business-Value (weeks)
            <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
              data-bs-content="The number of weeks after launch before the feature starts delivering measurable value. Examples include the first paying users, an improvement in key metrics, or visible customer adoption.">
            </i>
          </label>
          <input type="number" class="form-control" name="ttbv_weeks" min="0">
        </div>

        <!-- TTV-resultaten (samenvatting via partial template) -->
        <div id="ttv-results">
          {% include "features/_ttv_partial.html" %}
        </div>
      </div>
    </div>

    <!-- CONFIDENCE: bewijslast & confidence score voor de VECTR-grafiek -->
    <div class="mb-4 mt-4">
      <h4 class="mb-3">Evidence & Confidence Level</h4>

      <label class="form-label mb-2">
        Confidence Score
        <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-html="true"
          data-bs-placement="top"
          data-bs-content="Confidence is based on the strongest available evidence. Score range: 0.01 (very weak) &rarr; 10 (strong launch data). Used for the X-axis position in the VECTR graph.">
        </i>
      </label>

      <select class="form-select" name="quality_score" required>
        <option value="">Select score</option>
          <option value="0">No Longer Relevant (0.0) - Evidence is outdated or invalid and will no longer be considered.</option>
          <option value="0.01">Self Conviction (0.01) - Your own belief or intuition that the feature is important.</option>
          <option value="0.03">Pitch Deck (0.03) - Information from high-level presentations; not validated.</option>
          <option value="0.1">Thematic Support (0.10) - Fits the overall strategy but has no strong evidence.</option>
          <option value="0.2">Other's Opinion (0.20) - Someone else's judgement; subjective evidence.</option>
          <option value="0.5">Estimates & Plans (0.50) - Forward-looking assumptions or planning data.</option>
          <option value="1">Anecdotal Evidence (1.0) - Stories, experiences, isolated examples.</option>
          <option value="2">Market Data (2.0) - Research or trend information; moderately strong.</option>
          <option value="3">User/Customer Evidence (3.0) - Direct feedback or behavior from users.</option>
          <option value="7">Test Results (7.0) - Data from experiments or tests; very strong evidence.</option>
          <option value="10">Launch Data (10.0) - Real usage data after launch; strongest evidence.</option>
      </select>
  </div>

    <!-- Formulierknoppen: opslaan of annuleren -->
    <button type="submit" class="btn btn-base btn-primary-custom w-100 mt-3">
      Save
    </button>

    <a href="{{ url_for('main.projects', project_id=project.id_project) }}"
      class="btn btn-base btn-secondary-custom w-100 mt-2">
      Cancel
    </a>
  </form>
</div>

<script>

  // Initialiseer alle Bootstrap Popovers op de pagina
  document.addEventListener('DOMContentLoaded', function () {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      // Gebruik de 'html: true' optie als je HTML in de Popover content wilt, maar hier niet nodig

      return new bootstrap.Popover(popoverTriggerEl)
    })
  });
</script>

{% endblock %}