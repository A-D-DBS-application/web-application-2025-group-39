{% extends "base.html" %}

{% block title %}Features for {{ project.project_name }}{% endblock %}
{% block body_class %}projects-body{% endblock %}

{% block content %}


<h2 class="mb-4 text-center">Features Overview: {{ project.project_name }}</h2>

<!-- Top action buttons -->
<div class="mb-3 d-flex justify-content-center gap-2 flex-wrap">
    <a href="{{ url_for('main.add_feature', project_id=project.id_project) }}" class="btn btn-base btn-primary-custom">
        + Add New Feature
    </a>

    <a href="{{ url_for('main.vectr_chart', project_id=project.id_project) }}" class="btn btn-vectr btn-sm">
        ðŸ“ˆ VECTR Chart
    </a>
</div>


<div class="features-container-card">

    {% if features|length == 0 %}

    <div class="text-center py-4 text-muted">
        No features yet â€” add one soon!
    </div>

    {% else %}
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">

            <thead class="table-light">
                <tr>
                    <th class="text-center">Title</th>

                    <!-- ROI Column -->
                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='roi', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'roi' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a>
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='roi', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'roi' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a>
                                {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %}
                            </div>
                            <strong>ROI (%)</strong>
                        </div>
                    </th>

                    <!-- TtV Column -->
                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='ttv', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'ttv' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a>
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='ttv', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'ttv' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a>
                                {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %}
                            </div>
                            <strong>TtV (Weeks)</strong>
                        </div>
                    </th>

                    <!-- Confidence Column -->
                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='confidence', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'confidence' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a>
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='confidence', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'confidence' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a>
                                {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %}
                            </div>
                            <strong>Confidence</strong>
                        </div>
                    </th>

                    <th class="text-center">VECTR Score</th>
                    <th class="text-center">Horizon</th>
                    <!--Decision Column-->
                    <th class="text-center">Decision (set)</th>
                    <th class="text-center">Decision (status)</th>
                    <!-- Evidence Column -->
                    <th class="text-center">Evidence</th>
                    <!-- Actions Column -->
                    <th class="text-center col-actions">Actions</th>
                </tr>
            </thead>

            <tbody class="text-center">
                {% for feature in features %}
                <tr>

                    <td>{{ feature.name_feature }}</td>

                    <td>
                        {% if feature.roi_percent is not none %}
                        {{ "%.1f" | format(feature.roi_percent) }}%
                        {% else %} N/A {% endif %}
                    </td>

                    <td>
                        {% if feature.ttv_weeks is not none %}
                        {{ "%.0f" | format(feature.ttv_weeks) }}
                        {% else %} N/A {% endif %}
                    </td>

                    <td>
                        {% if feature.quality_score is not none %}
                        {{ "%.2f" | format(feature.quality_score) }}
                        {% else %} N/A {% endif %}
                    </td>

                    <td>
                        {% if feature.vectr_score is not none %}
                        <strong>{{ feature.vectr_score | round(2) }}</strong>
                        {% else %}
                        -
                        {% endif %}
                    </td>

                    <td>{{ feature.horizon }} Months</td>

                    <!-- DECISION BUTTONS-->
                    <td>
                        <div class="d-flex flex-column align-items-center gap-2">

                            {# De knop die de beslissing 'Yes' (Approved) via POST verstuurt #}
                            <form method="POST"
                                action="{{ url_for('main.set_feature_decision', feature_id=feature.id_feature, decision_value='Yes') }}"
                                style="display:inline;">
                                <button type="submit" class="btn-base table-btn btn-decision-yes"
                                    title="Keur de feature goed">
                                    Yes
                                </button>
                            </form>

                            {# De knop die de beslissing 'No' (Rejected) via POST verstuurt #}
                            <form method="POST"
                                action="{{ url_for('main.set_feature_decision', feature_id=feature.id_feature, decision_value='No') }}"
                                style="display:inline;">
                                <button type="submit" class="btn-base table-btn btn-danger-custom"
                                    title="Keur de feature af">
                                    No
                                </button>
                            </form>

                        </div>
                    </td>

                    <td>
                        {# 1. Haal de meest recente beslissing op uit de Decisions lijst. #}
                        {% set latest_decision = feature.decisions | sort(attribute='created_at', reverse=True) | first
                        %}

                        {% if latest_decision %}
                        {# 2. Toon de beslissing met een CSS klasse voor de styling (bv. decision-approved) #}
                        <span class="decision-{{ latest_decision.decision_type | lower }}">{{
                            latest_decision.decision_type }}</span>
                        {% else %}
                        {# 3. Toon 'Nog geen beslissing' als er geen Decision records zijn. #}
                        <span class="decision-pending">No decision yet</span>
                        {% endif %}
                    </td>


                    <!-- EVIDENCE BUTTONS -->
                    <td>
                        <div class="d-flex flex-column align-items-center gap-2">

                            <a href="{{ url_for('main.add_evidence', feature_id=feature.id_feature) }}"
                                class="btn btn-success table-btn btn-sm">
                                + Evidence
                            </a>

                            <a href="{{ url_for('main.view_evidence', feature_id=feature.id_feature) }}"
                                class="btn btn-view table-btn btn-sm">
                                View
                            </a>

                        </div>
                    </td>

                    <!-- ACTIONS -->
                    <td>
                        <div class="d-flex flex-column align-items-center gap-2">

                            <a href="{{ url_for('main.edit_feature', feature_id=feature.id_feature) }}"
                                class="btn btn-edit table-btn btn-sm">
                                Edit
                            </a>

                            <form action="{{ url_for('main.delete_feature', feature_id=feature.id_feature) }}"
                                method="post">
                                <button type="submit"
                                    onclick="return confirm('Are you sure you want to delete this feature?');"
                                    class="btn btn-danger-custom table-btn btn-sm">
                                    Delete
                                </button>
                            </form>

                        </div>
                    </td>

                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>



    {% endif %}
</div>

{% endblock %}