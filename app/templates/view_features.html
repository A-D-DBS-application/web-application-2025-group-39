{% extends "base.html" %}

{% block title %}Features for {{ project.project_name }}{% endblock %}
{% block body_class %}projects-body{% endblock %}

{% block content %}

<!-- PAGETITLE -->
<h2 class="mb-4 text-center">Feature Ideas: {{ project.project_name }}</h2>

<!-- TOP ACTION BUTTONS -->
<div class="mb-3 d-flex justify-content-center gap-2 flex-wrap">
    <a href="{{ url_for('main.add_feature', project_id=project.id_project) }}" class="btn btn-base btn-primary-custom">                                                <!--Link naar â€œadd_featureâ€ route met project_id parameter -->
        + Add New Feature
    </a>

    <a href="{{ url_for('main.vectr_chart', project_id=project.id_project) }}" class="btn btn-vectr btn-sm">                                                           <!-- Link naar VECTR chart pagina voor dit project -->
        ðŸ“ˆ VECTR Chart
    </a>
</div>

<!-- FEATURES LIST CONTAINER -->
<div class="features-container-card">                                                                                                                                   <!-- Wrapper voor styling (bv. card look, padding, achtergrond) -->

    {% if features|length == 0 %}                                                                                                                                      <!-- Als er geen features zijn, toon een lege-state -->

    <div class="text-center py-4 text-muted">
        No feature ideas yet â€” add one soon!
    </div>

    {% else %}
    <div class="table-responsive">                                                                                                                                     <!-- Bootstrap: zorgt dat de tabel horizontaal kan scrollen op kleine schermen -->
        <table class="table table-striped table-bordered align-middle">

            <!-- TABLE HEADER -->
            <thead class="table-light">
                <tr>
                    <th class="text-center">Title</th>

                    <!-- ROI COLUMN (SORTABLE) -->
                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='roi', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'roi' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a>                                                                                                                                    <!-- Link die ROI oplopend sorteert; active class als dit de huidige sort is -->
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='roi', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'roi' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a>                                                                                                                                    <!-- Link die ROI aflopend sorteert; active class als dit de huidige sort is -->
                                {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %}                                                                                                                             <!-- Als sorteren niet kan: toon â€œdummyâ€ pijlen voor consistente layout -->
                            </div>
                            <strong>ROI (%)</strong>
                        </div>
                    </th>

                    <!-- TtV COLUMN (SORTABLE) -->
                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='ttv', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'ttv' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a>                                                                                                                                    <!-- Link die TtV oplopend sorteert; active class als dit de huidige sort is -->
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='ttv', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'ttv' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a>                                                                                                                                    <!-- Link die TtV aflopend sorteert; active class als dit de huidige sort is -->
                                {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %}                                                                                                                             <!-- Als sorteren niet kan: toon â€œdummyâ€ pijlen voor consistente layout -->
                            </div>
                            <strong>TtV (Weeks)</strong>                                                                                                                <!-- Kolom toont time-to-value in weken -->
                        </div>
                    </th>

                    <!-- CONFIDENCE COLUMN (SORTABLE) -->
                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='confidence', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'confidence' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a>                                                                                                                                   <!-- Link die Confidence oplopend sorteert; active class als dit de huidige sort is -->
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='confidence', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'confidence' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a>                                                                                                                                   <!-- Link die Confidence aflopend sorteert; active class als dit de huidige sort is -->
                                {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %}                                                                                                                            <!-- Als sorteren niet kan: toon â€œdummyâ€ pijlen voor consistente layout -->
                            </div>
                            <strong>Confidence</strong>
                        </div>
                    </th>

                    <!--vectr score sortable-->
                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='vectr', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'vectr' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a> 
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='vectr', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'vectr' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a> 
                                {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %} 
                            </div>
                            <strong>VECTR Score</strong>
                        </div>
                    </th> 
                    <th class="text-center">Horizon</th>
                                                                                                                             

                    <!-- DECISION COLUMN (SORTABLE) -->
                    <th class="text-center">Decision (set)</th>                                                                                                        <!-- Knoppen om decision te zetten -->
                    <th class="text-center">Decision (status)</th>                                                                                                     <!-- Laatste decision status tonen -->

                    <!-- EVIDENCE COLUMN -->
                    <th class="text-center">Evidence</th>                                                                                                              <!-- Knoppen voor evidence toevoegen/bekijken -->
                    <!-- ACTIONS COLUMN -->
                    <th class="text-center col-actions">Actions</th>                                                                                                   <!-- Acties zoals edit/delete; col-actions is extra CSS-hook voor breedte/styling -->
                </tr>
            </thead>

            <!-- TABLE BODY (FEATURE ROWS) -->
            <tbody class="text-center">
                {% for feature in features %}
                <tr>

                                                                                                                                                                       <!-- DEZE REGEL IS DE OPLOSSING! Definieer de variabele BOVEN de cellen (<td>) die deze variabele nodig hebben. Hierdoor is 'latest_decision' beschikbaar voor de knoppen en de status -->
                        {% set decisions = feature.decisions %}
                        {% set total_votes = decisions | length %}
                        {% set yes_votes = decisions | selectattr('decision_type', 'equalto', 'Approved') | list | length %}
                        {% set yes_percentage = (yes_votes / total_votes * 100) if total_votes > 0 else 0 %}
                        {% set user_decision = decisions | selectattr('id_profile', 'equalto', current_user.id_profile) | list | first %}


                    <td>{{ feature.name_feature }}</td>

                    <td>
                        {% if feature.roi_percent is not none %}
                        {{ "%.1f" | format(feature.roi_percent) }}%
                        {% else %} N/A {% endif %}
                    </td>

                    <td>
                        {% if feature.ttv_weeks is not none %}
                        {{ "%.0f" | format(feature.ttv_weeks) }}
                        {% else %} N/A {% endif %}
                    </td>

                    <td>
                        {% if feature.quality_score is not none %}
                        {{ "%.2f" | format(feature.quality_score) }}
                        {% else %} N/A {% endif %}
                    </td>

                    <td>
                        {% if feature.vectr_score is not none %}
                        <strong>{{ feature.vectr_score | round(2) }}</strong>
                        {% else %}
                        -
                        {% endif %}
                    </td>

                    <td>{{ feature.horizon }} Months</td>

                    <td>
                        <div class="d-flex flex-column align-items-center gap-2">

                            <form method="POST"
                                action="{{ url_for('main.set_feature_decision', feature_id=feature.id_feature, decision_value='Yes') }}"
                                style="display:inline;">
                                <button type="submit" class="btn-base table-btn btn-decision-yes
                        {# MARKEREN ALS DE HUIDIGE GEBRUIKER VOOR JA HEEFT GESTEMD #}
                        {% if user_decision and user_decision.decision_type == 'Approved' %}is-selected{% endif %}" 
                                    title="Keur de feature goed">
                                    Yes
                                </button>
                            </form>
                            <form method="POST"
                                action="{{ url_for('main.set_feature_decision', feature_id=feature.id_feature, decision_value='No') }}"
                                style="display:inline;">
                                <button type="submit" class="btn-base table-btn btn-decision-no
                        {# MARKEREN ALS DE HUIDIGE GEBRUIKER VOOR NEE HEEFT GESTEMD #}
                        {% if user_decision and user_decision.decision_type == 'Rejected' %}is-selected{% endif %}"
                                    title="Keur de feature af">
                                    No
                                </button>
                            </form>

                        </div>
                    </td>

                    <td>
                        {% if total_votes > 0 %}
                        <div class="d-flex flex-column align-items-center gap-1">
                            <span class="decision-approved">
                                Yes votes: {{ yes_percentage | round(0) }}% ({{ yes_votes }}/{{ total_votes }})
                            </span>
                            {% if user_decision %}
                            <span class="decision-{{ user_decision.decision_type | lower }}">
                                Your vote: {{ user_decision.decision_type }}
                            </span>
                            {% endif %}
                        </div>
                        {% else %}
                        <span class="decision-pending">No votes yet</span>
                        {% endif %}
                    </td>

                    <td>
                        <div class="d-flex flex-column align-items-center gap-2">
                            <a href="{{ url_for('main.add_evidence', feature_id=feature.id_feature) }}"
                                class="btn btn-success table-btn btn-sm">
                                + Evidence
                            </a>
                            <a href="{{ url_for('main.view_evidence', feature_id=feature.id_feature) }}"
                                class="btn btn-view table-btn btn-sm">
                                View
                            </a>
                        </div>
                    </td>

                    <td>
                        <div class="d-flex flex-column align-items-center gap-2">
                            <a href="{{ url_for('main.edit_feature', feature_id=feature.id_feature) }}"
                                class="btn btn-edit table-btn btn-sm">
                                Edit
                            </a>
                            <form action="{{ url_for('main.delete_feature', feature_id=feature.id_feature) }}"
                                method="post">
                                <button type="submit"
                                    onclick="return confirm('Are you sure you want to delete this feature?');"
                                    class="btn btn-danger-custom table-btn btn-sm">
                                    Delete
                                </button>
                            </form>

                        </div>
                    </td>

                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>



    {% endif %}
</div>

{% endblock %}