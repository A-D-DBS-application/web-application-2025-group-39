{% extends "base.html" %}

{% block title %}Features for {{ project.project_name }}{% endblock %}
{% block body_class %}projects-body{% endblock %}

{% block content %}

<h2 class="mb-4 text-center">Feature Ideas: {{ project.project_name }}</h2>

<div class="mb-3 d-flex justify-content-center gap-2 flex-wrap">
    <a href="{{ url_for('main.add_feature', project_id=project.id_project) }}" class="btn btn-base btn-primary-custom">
        + Add New Feature
    </a>

    <a href="{{ url_for('main.vectr_chart', project_id=project.id_project) }}" class="btn btn-vectr btn-sm">
        ðŸ“ˆ VECTR Chart
    </a>
</div>

<div class="features-container-card"> {% if features|length == 0 %} <div class="text-center py-4 text-muted">
        No feature ideas yet â€” add one soon!
    </div>

    {% else %}
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">

            <thead class="table-light">
                <tr>
                    <th class="text-center">Title</th>

                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='roi', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'roi' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a> <a
                                    href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='roi', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'roi' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a> {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %}
                            </div>
                            <strong>ROI (%)</strong>
                        </div>
                    </th>

                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='ttv', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'ttv' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a> <a
                                    href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='ttv', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'ttv' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a> {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %}
                            </div>
                            <strong>TtV (Weeks)</strong>
                        </div>
                    </th>

                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='confidence', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'confidence' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a>
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='confidence', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'confidence' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a>
                                {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %}
                            </div>
                            <strong>Confidence</strong>
                        </div>
                    </th>

                    <th class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="me-2">
                                {% if can_sort %}
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='vectr', direction='asc') }}"
                                    class="sort-icon {% if current_sort == 'vectr' and current_direction == 'asc' %}active{% endif %}">
                                    &#9650;
                                </a>
                                <a href="{{ url_for('main.view_features', project_id=project.id_project, sort_by='vectr', direction='desc') }}"
                                    class="sort-icon {% if current_sort == 'vectr' and current_direction == 'desc' %}active{% endif %}">
                                    &#9660;
                                </a>
                                {% else %}
                                <span class="sort-icon-placeholder">&#9650;</span>
                                <span class="sort-icon-placeholder">&#9660;</span>
                                {% endif %}
                            </div>
                            <strong>VECTR Score</strong>
                        </div>
                    </th>
                    <th class="text-center">Horizon</th>


                    <th class="text-center">Decision (set)</th>
                    <th class="text-center">Decision (status)</th>
                    <th class="text-center">Evidence</th>
                    <th class="text-center col-actions">Actions</th>
                </tr>
            </thead>

            <tbody class="text-center">
                {% for feature in features %}
                <tr>

                    {% set decisions = feature.decisions %}
                    {% set total_votes = decisions | length %}
                    {% set yes_votes = decisions | selectattr('decision_type', 'equalto', 'Approved') | list | length %}
                    {% set yes_percentage = (yes_votes / total_votes * 100) if total_votes > 0 else 0 %}
                    {% set user_decision = decisions | selectattr('id_profile', 'equalto', current_user.id_profile) |
                    list | first %}

                    <!-- START VAN OUTLIER/ZERO OR NEGATIVE VECTR CHECK -->
                    <td>
                        <div class="d-flex align-items-center">

                            <!-- Bepaal of een waarschuwing getoond moet worden (Outlier OF Score <= 0) -->
                            {% set is_zero_or_negative_score=feature.vectr_score is not none and feature.vectr_score <=0
                                %} <!-- WIJZIGING: Toon de waarschuwing ALLEEN als deze nog NIET is afgewezen in de DB
                                -->
                                {% set show_warning = (feature.is_outlier or is_zero_or_negative_score) and not
                                feature.warning_dismissed %}

                                {% if show_warning %}
                                <!-- Bepaal de unieke ID en het waarschuwingstype -->
                                {% set warning_id=feature.outlier_id if feature.is_outlier else 'zero-neg-vectr-' ~ feature.id_feature %} 

                                {% set warning_type='Extreme Value (' ~ feature.outlier_type ~ ')' if feature.is_outlier else 'Zero/Negative VECTR Score' %} 

                                {% set warning_text='This feature has an unusual value: ' ~ feature.outlier_type ~ '. Please verify if this is correct.' if feature.is_outlier else 'VECTR Score is ' ~ feature.vectr_score|round(2) ~ '. Check input data.' %}
                                <!--Gebruik ALTIJD text-danger voor de rode kleur, wat overeenkomt met de styling van de outliers -->
                                {% set warning_class='text-danger' %}

                                <span id="{{ warning_id }}-container" class="me-2 outlier-container"
                                    data-outlier-id="{{ warning_id }}">

                                    <!-- TRIGGER (Icoon) -->
                                    <i class="bi bi-exclamation-triangle-fill outlier-icon outlier-trigger {{ warning_class }}"
                                        title="{{ warning_type }}" data-bs-toggle="popover"
                                        data-bs-trigger="hover focus" data-bs-placement="right" data-bs-html="true"
                                        data-bs-custom-class="popover-hover"
                                        data-bs-content-id="popover-content-{{ warning_id }}" style="cursor: pointer;">
                                    </i>

                                    <!-- VERBORGEN INHOUD VOOR DE POPOVER -->
                                    <div id="popover-content-{{ warning_id }}" style="display:none;">
                                        <p class="mb-2 small fw-bold {{ warning_class }}">
                                            Warning: {{ warning_type }}
                                        </p>
                                        <p class="mb-2 small text-muted">
                                            {{ warning_text }}
                                            If the data has been verified, you may remove this
                                            warning.
                                        </p>
                                        <!--WIJZIGING: Roept de browser confirm wrapper aan -->
                                        <button class="btn btn-sm btn-danger-custom w-100"
                                            onclick="confirmAndDismissWarning('{{ warning_id }}')">
                                            Remove Warning
                                        </button>
                                    </div>
                                    <!-- EINDE VERBORGEN INHOUD -->
                                </span>
                                {% endif %}

                                {{ feature.name_feature }}
                        </div>
                    </td>
                    <!-- EINDE OUTLIER/ZERO OR NEGATIVE VECTR CHECK -->
                    <td>
                        {% if feature.roi_percent is not none %}
                        {{ "%.1f" | format(feature.roi_percent) }}%
                        {% else %} N/A {% endif %}
                    </td>

                    <td>
                        {% if feature.ttv_weeks is not none %}
                        {{ "%.0f" | format(feature.ttv_weeks) }}
                        {% else %} N/A {% endif %}
                    </td>

                    <td>
                        {% if feature.quality_score is not none %}
                        {{ "%.2f" | format(feature.quality_score) }}
                        {% else %} N/A {% endif %}
                    </td>

                    <td>
                        {% if feature.vectr_score is not none %}
                        <strong>{{ feature.vectr_score | round(2) }}</strong>
                        {% else %}
                        -
                        {% endif %}
                    </td>

                    <td>{{ feature.horizon }} Months</td>

                    <td>
                        <div class="d-flex flex-column align-items-center gap-2">

                            <form method="POST"
                                action="{{ url_for('main.set_feature_decision', id_feature=feature.id_feature, decision_value='Yes') }}"
                                style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn-base table-btn btn-decision-yes
                        {# MARKEREN ALS DE HUIDIGE GEBRUIKER VOOR JA HEEFT GESTEMD #}
                        {% if user_decision and user_decision.decision_type == 'Approved' %}is-selected{% endif %}"
                                    title="Keur de feature goed">
                                    Yes
                                </button>
                            </form>
                            <form method="POST"
                                {{ csrf_token() }}
                                action="{{ url_for('main.set_feature_decision', id_feature=feature.id_feature, decision_value='No') }}"
                                style="display:inline;">
                                <button type="submit" class="btn-base table-btn btn-decision-no
                        {# MARKEREN ALS DE HUIDIGE GEBRUIKER VOOR NEE HEEFT GESTEMD #}
                        {% if user_decision and user_decision.decision_type == 'Rejected' %}is-selected{% endif %}"
                                    title="Keur de feature af">
                                    No
                                </button>
                            </form>

                        </div>
                    </td>

                    <td>
                        {% if total_votes > 0 %}
                        <div class="d-flex flex-column align-items-center gap-1">
                            <span class="decision-approved">
                                Yes votes: {{ yes_percentage | round(0) }}% ({{ yes_votes }}/{{ total_votes }})
                            </span>
                        </div>
                        {% else %}
                        <span class="decision-pending">No votes yet</span>
                        {% endif %}
                    </td>

                    <td>
                        <div class="d-flex flex-column align-items-center gap-2">
                            <a href="{{ url_for('main.add_evidence', id_feature=feature.id_feature) }}"
                                class="btn btn-success table-btn btn-sm">
                                + Evidence
                            </a>
                            <a href="{{ url_for('main.view_evidence', id_feature=feature.id_feature) }}"
                                class="btn btn-view table-btn btn-sm">
                                View
                            </a>
                        </div>
                    </td>

                    <td>
                        <div class="d-flex flex-column align-items-center gap-2">
                            <a href="{{ url_for('main.edit_feature', id_feature=feature.id_feature) }}"
                                class="btn btn-edit table-btn btn-sm">
                                Edit
                            </a>
                            <form action="{{ url_for('main.delete_feature', id_feature=feature.id_feature) }}"
                                {{ csrf_token() }}
                                method="post">
                                <button type="submit"
                                    onclick="return confirm('Are you sure you want to delete this feature?');"
                                    class="btn btn-danger-custom table-btn btn-sm">
                                    Delete
                                </button>
                            </form>

                        </div>
                    </td>

                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>
    {% endif %}
</div>
{% endblock %}