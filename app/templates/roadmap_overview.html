{% extends "base.html" %}

{% block title %}Roadmap Overview{% endblock %}
{% block body_class %}roadmap-body{% endblock %}

{% block content %}

  <!-- TOP RIGHT BUTTON: BACK TO PROJECTS -->
  <div class="top-right">
    <a href="{{ url_for('main.projects') }}" class="btn btn-base btn-nav btn-sm">Projects Overview</a>
  </div>

  <!-- PAGE HEADER -->
  <h2>Roadmap for {{ project.project_name }}</h2>
  <p class="text-muted">{{ project.company.company_name }}</p>

  <!-- NO ROADMAP YET -->
  {% if roadmaps|length == 0 %}
    <div class="alert alert-info mt-4">
      No roadmap has been created for this project yet.
    </div>

    {% if session['role'] == 'founder' %}
      <a href="{{ url_for('main.add_roadmap', project_id=project.id_project) }}" class="btn btn-primary mt-3">Add Roadmap</a>
    {% endif %}

  {% else %}

    {% set r = roadmaps[0] %} <!-- Because max 1 roadmap exists -->

    <!-- ROADMAP CARD -->
    <div class="roadmap-card card shadow-sm p-4 mt-3">
      <h4 class="mb-1">{{ r.quarter }}</h4>
      <p class="small text-secondary">Created {{ r.createdat.strftime('%d %b %Y') }}</p>

      <div class="row g-3 mt-2">
        <div class="col-md-4">
          <div class="roadmap-metric">
            <p class="label">Team Size</p>
            <p class="value">{{ r.team_size }}</p>
          </div>
        </div>

        <div class="col-md-4">
          <div class="roadmap-metric">
            <p class="label">Sprint Capacity</p>
            <p class="value">{{ r.sprint_capacity }}</p>
          </div>
        </div>

        <div class="col-md-4">
          <div class="roadmap-metric">
            <p class="label">Budget Allocation</p>
            <p class="value">{{ '%.2f'|format(r.budget_allocation) }}</p>
          </div>
        </div>
      </div>

      {% if session['role'] == 'founder' %}
        <a href="{{ url_for('main.edit_roadmap', roadmap_id=r.id_roadmap) }}"
           class="btn btn-edit mt-3 w-100">Edit Roadmap</a>
      {% endif %}
    </div>

    <!-- MILESTONES TABLE -->
    <div class="card shadow-sm p-4 mt-4">
      <h4 class="mb-3">Milestones</h4>

      {% if r.milestones|length == 0 %}
        <p class="text-muted">No milestones yet.</p>
      {% else %}
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>Milestone</th>
              <th>Start date</th>
              <th>End date</th>
              <th>Goals</th>
              <th>Status</th>
              {% if session['role'] == 'founder' %}
                <th>Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for m in r.milestones %}
              <tr>
                <td>{{ m.name }}</td>
                <td>{{ m.start_date.strftime("%d/%m/%Y") if m.start_date }}</td>
                <td>{{ m.end_date.strftime("%d/%m/%Y") if m.end_date }}</td>
                <td>{{ m.goal }}</td>
                <td>{{ m.status }}</td>

                {% if session['role'] == 'founder' %}
                  <td>
                    <a href="{{ url_for('main.edit_milestone', milestone_id=m.id_milestone) }}"
                       class="btn btn-sm btn-primary">Edit</a>

                    <form method="POST"
                          action="{{ url_for('main.delete_milestone', milestone_id=m.id_milestone) }}"
                          style="display:inline;"
                          onsubmit="return confirm('Delete this milestone? ')">
                      <button class="btn btn-sm btn-danger">Delete</button>
                    </form>
                  </td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}

      {% if session['role'] == 'founder' %}
        <a href="{{ url_for('main.add_milestone', roadmap_id=r.id_roadmap) }}"
           class="btn btn-primary mt-3 w-100">+ Add Milestone</a>
      {% endif %}

    </div>

  {% endif %}

{% endblock %}
