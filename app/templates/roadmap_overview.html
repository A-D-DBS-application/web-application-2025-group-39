{% extends "base.html" %}

{% block title %}Roadmap Overview{% endblock %}
{% block body_class %}roadmap-body{% endblock %}

{% block content %}

<div class="roadmap-header">
  <h2>Roadmap for {{ project.project_name }}</h2>
  <div class="top-right">
    <a href="{{ url_for('main.projects') }}" class="btn btn-base btn-nav btn-sm">Projects Overview</a>
  </div>
</div>

{% if roadmaps|length == 0 %}
  <div class="card p-4 mx-auto" style="max-width: 700px;">
    <div class="alert alert-info mb-0">
      No roadmap has been created for this project yet.
    </div>
    {% if session['role'] == 'founder' %}
      <div class="mt-3 text-center">
        <a href="{{ url_for('main.add_roadmap', project_id=project.id_project) }}"
           class="btn btn-primary-custom">
          + Add First Roadmap
        </a>
      </div>
    {% endif %}
  </div>
{% else %}

  <div class="roadmap-container">

    {% for r in roadmaps %}
      <!-- Single Roadmap Block -->
      <div class="mb-4">

        <!-- Roadmap Meta Card -->
        <div class="card mb-3 p-3">
          <div class="d-flex flex-wrap justify-content-between align-items-center">
            <div>
              <h5 class="mb-1">
                {{ r.start_quarter }} â†’ {{ r.end_quarter }}
              </h5>
              <small class="text-muted">
                Created {{ r.createdat.strftime('%d/%m/%Y') if r.createdat }}
              </small>
            </div>

            <div class="d-flex flex-wrap gap-3 mt-2 mt-md-0">
              <div>
                <span class="text-muted">Team size</span><br>
                <strong>{{ r.team_size }}</strong>
              </div>
              <div>
                <span class="text-muted">Sprint capacity</span><br>
                <strong>{{ r.sprint_capacity }}</strong>
              </div>
              <div>
                <span class="text-muted">Budget allocation</span><br>
                <strong>{{ r.budget_allocation }}</strong>
              </div>
            </div>

            {% if session['role'] == 'founder' %}
              <div class="mt-3 mt-md-0">
                <a href="{{ url_for('main.edit_roadmap', roadmap_id=r.id_roadmap) }}"
                   class="btn btn-edit btn-sm">
                  Edit Roadmap
                </a>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Milestones Row -->
        <div class="milestones-row">
          <div class="milestone-group">

            {% if r.milestones|length == 0 %}
              <p class="text-muted-small">No milestones yet for this roadmap.</p>
            {% endif %}

            {% for m in r.milestones %}
              <div class="milestone-card">
                <div class="milestone-name">
                  {{ m.name }}
                </div>

                <div class="milestone-info">
                  <strong>Start:</strong>
                  {{ m.start_date.strftime("%d/%m/%Y") if m.start_date else 'N/A' }}
                </div>
                <div class="milestone-info">
                  <strong>End:</strong>
                  {{ m.end_date.strftime("%d/%m/%Y") if m.end_date else 'N/A' }}
                </div>
                <div class="milestone-info">
                  <strong>Goal:</strong> {{ m.goal or 'N/A' }}
                </div>

                <!-- Status Badge -->
                <div class="milestone-info">
                  <strong>Status:</strong>
                  {% set status_class = (m.status or 'pending') | lower | replace(' ', '-') %}
                  <span class="status-{{ status_class }}">{{ m.status or 'Pending' }}</span>
                </div>

                <!-- Features List -->
                {% if m.features|length > 0 %}
                  <div class="milestone-info">
                    <strong>Features:</strong>
                    <ul style="margin: 0; padding-left: 18px; font-size: 0.8rem;">
                      {% for feat in m.features %}
                        <li>{{ feat.name_feature }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}

                {% if session['role'] in ['founder', 'PM'] %}
                  <div class="milestone-actions">
                    <a href="{{ url_for('main.edit_milestone', milestone_id=m.id_milestone) }}"
                       class="edit-btn">
                      Edit
                    </a>
                    <form method="POST"
                          action="{{ url_for('main.delete_milestone', milestone_id=m.id_milestone) }}"
                          onsubmit="return confirm('Are you sure you want to delete this milestone?')"
                          style="display:inline;">
                      <button class="delete-btn" type="submit">Delete</button>
                    </form>
                  </div>
                {% endif %}
              </div>
            {% endfor %}

            {% if session['role'] in ['founder', 'PM'] %}
              <a href="{{ url_for('main.add_milestone', roadmap_id=r.id_roadmap) }}"
                 class="btn btn-add-milestone-small">
                + Add Milestone
              </a>
            {% endif %}

          </div>
        </div>

      </div>
    {% endfor %}

  </div>

{% endif %}

{% endblock %}
