{% extends "base.html" %}

{% block title %}Roadmap Overview{% endblock %}
{% block body_class %}roadmap-body{% endblock %}

{% block content %}

<div class="roadmap-header"> <!-- Wrapper voor de paginaheader (layout/styling in CSS) -->
  <h2>Roadmap for {{ project.project_name }}</h2>
</div>

{% if roadmaps|length == 0 %} <!-- Als er geen roadmaps bestaan voor dit project -->
<div class="card p-4 mx-auto" style="max-width: 700px;">
  <div class="alert alert-info mb-0">
    No roadmap has been created for this project yet.
  </div>
  <!-- De eerste roadmap mag alleen door Founder/PM gemaakt worden (PM edit check in routes.py) -->
  {% if session['role'] in ['Founder', 'PM'] %}
  <div class="mt-3 text-center">
    <a href="{{ url_for('main.add_roadmap', project_id=project.id_project) }}" class="btn btn-primary-custom">
      + Add First Roadmap
    </a> <!-- Link naar add_roadmap route met project_id parameter -->
  </div>
  {% endif %}
</div>
{% else %}

<div class="roadmap-container"> <!-- Wrapper voor alle roadmap blokken -->

  {% for r in roadmaps %}
  <div class="mb-4">

    <div class="card mb-3 p-3">
      <div class="d-flex flex-wrap justify-content-between align-items-center">
        <div>
          <h5 class="mb-1">
            {{ r.start_roadmap or 'N/A' }} â†’ {{ r.end_roadmap or 'N/A' }}
          </h5>

          <small class="text-muted">
            Created {{ r.createdat.strftime('%Y-%m-%d') if r.createdat }}
          </small>
        </div>

        <div class="d-flex flex-wrap gap-3 mt-2 mt-md-0">

          <div>
            <span class="text-muted">Total Time Capacity</span><br>
            <strong>{{ r.time_capacity }}</strong> <!-- Toont time capacity -->
          </div>

          <div>
            <span class="text-muted">Budget allocation</span><br>
            <strong>{{ r.budget_allocation }}</strong>
          </div>
        </div>

        <!-- KNOPPEN VOOR ROADMAP ZELF (Edit/Optimize) -->
        {% if session['role'] in ['Founder', 'PM'] %}
        <div class="mt-3 mt-md-0 d-flex gap-2">

          <!-- EDIT KNOP (Founder/PM) -->
          <a href="{{ url_for('main.edit_roadmap', roadmap_id=r.id_roadmap) }}" class="btn btn-base btn-edit btn-sm">
            Edit
          </a>

          <!-- OPTIMALISEER KNOP (Founder/PM - Kan PM ook doen) -->
          <a href="{{ url_for('main.roadmap_optimize', roadmap_id=r.id_roadmap) }}"
            class="btn btn-base btn-edit btn-sm">
            Optimize Features
          </a>

        </div>
        {% endif %}
      </div>
    </div>

    <div class="milestones-row">
      <div class="milestone-group"> <!-- Groepeert alle milestone cards binnen deze roadmap -->

        {% if r.milestones|length == 0 %}
        <p class="text-muted-small">No milestones yet for this roadmap.</p>
        <!-- Empty-state tekst als er nog geen milestones zijn -->
        {% endif %}

        {% for m in r.milestones %}
        <div class="milestone-card">

          <div class="milestone-name">
            {{ m.name }}
          </div>

          <div class="milestone-info">
            <strong>Start:</strong>
            {{ m.start_date if m.start_date else 'N/A' }}
          </div>
          <div class="milestone-info">
            <strong>End:</strong>
            {{ m.end_date if m.end_date else 'N/A' }}
          </div>
          <div class="milestone-info">
            <strong>Goal:</strong> {{ m.goal or 'N/A' }}
          </div>

          <div class="milestone-info">
            <strong>Status:</strong>
            {% set status_class = (m.status or 'pending') | lower | replace(' ', '-') %}
            <span class="status-{{ status_class }}">{{ m.status or 'Pending' }}</span>
          </div>

          {% if m.features|length > 0 %}
          <div class="milestone-info" style="display: flex; align-items: baseline;">

            <strong style="white-space: nowrap; margin-right: 5px;">Features:</strong>

            <ul
              style="margin: 0; padding-left: 0; font-size: 0.8rem; list-style-type: none; display: flex; flex-wrap: wrap; gap: 0;">
              {% for feat in m.features %}
              <li style="display: inline;">
                {{ feat.name_feature }}
                {% if not loop.last %},&nbsp;{% endif %}
              </li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}

          <!-- PM mag Edit, Founder mag Edit EN Delete -->
          {% if session['role'] in ['Founder', 'PM'] %}
          <div class="milestone-actions">

            <!-- EDIT KNOP (Founder/PM) -->
            <a href="{{ url_for('main.edit_milestone', milestone_id=m.id_milestone) }}" class="edit-btn">
              Edit
            </a>

            <!-- DELETE KNOP (ALLEEN Founder) -->
            {% if session['role'] == 'Founder' %}
            <form method="POST" action="{{ url_for('main.delete_milestone', milestone_id=m.id_milestone) }}"
              onsubmit="return confirm('Are you sure you want to delete this milestone?')" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">  
              <button class="delete-btn" type="submit">Delete</button>
            </form>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endfor %}

        {% if session['role'] in ['Founder', 'PM'] %}
        <a href="{{ url_for('main.add_milestone', roadmap_id=r.id_roadmap) }}" class="btn btn-add-milestone-small">
          + Add Milestone
        </a>
        {% endif %}

      </div>
    </div>

  </div>
  {% endfor %}

</div>

{% endif %}

{% endblock %}