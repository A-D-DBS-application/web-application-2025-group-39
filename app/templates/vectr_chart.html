{% extends "base.html" %}

{% block title %}VECTR Prioritization: {{ project.project_name }}{% endblock %}

{% block content %}
<div class="bottom-info">
    Logged in as: <strong>{{ session['name'] }}</strong> | Role: <strong>{{ session['role'] }}</strong>
</div>

    <h2 class="text-center mb-4">VECTR Prioritization Chart for {{ project.project_name }}</h2>
    
    <div class="top-right">
        <a href="{{ url_for('main.view_features', project_id=project.id_project) }}" 
        class="btn btn-base btn-nav btn-sm">
        Features Overview
        </a>
    </div>

    <div class="text-center">
        <a href="{{ url_for('main.add_feature', project_id=project.id_project) }}" 
           class="btn btn-base btn-primary-custom">
            + Add Feature
        </a>
    </div>

    <div id="chartData" style="display:none;">{{ chart_data | tojson }}</div>

    <div class="card shadow p-4 mx-auto vectr-card">
        <canvas id="vectrChart"></canvas>
        <p class="text-center mt-3 text-muted">
            X-axis: Confidence | Y-axis: TtV | Bubble Size: ROI (The bigger the bubble, the higher the ROI)
        </p>
        <div class="d-flex justify-content-end mt-3">
            <a href="{{ url_for('main.vectr_chart_pdf', project_id=project.id_project) }}" 
                class="btn btn-secondary-custom">
                    Download PDF
            </a>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="{{ url_for('static', filename='js/feature_calculations.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chartData = JSON.parse(document.getElementById("chartData").textContent);
            const ctx = document.getElementById('vectrChart').getContext('2d');
            
            // ====================================================
            // 1. Custom Plugin: VECTR Zes Zones (gebruik de grenzen uit de referentieafbeelding)
            // ====================================================
            const sixZonePlugin = {
                id: 'six_zones',
                beforeDraw(chart, args, options) {
                    const { ctx, chartArea: { left, top, right, bottom }, scales: { x, y } } = chart;
                    ctx.save();
                    
                    // Grenswaarden voor Confidence (X-as)
                    const x_low = x.getPixelForValue(1);
                    const x_mid_high = x.getPixelForValue(7); 

                    // Grenswaarden voor TtV (Y-as, omgekeerd)
                    const y_slow = y.getPixelForValue(5);
                    const y_mid = y.getPixelForValue(7);
                    
                    const drawZone = (color, x1, y1, x2, y2) => {
                        ctx.fillStyle = color;
                        ctx.fillRect(x1, y1, x2 - x1, y2 - y1);
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)'; // Optioneel: Border toevoegen
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                    };
                    
                    // Teken de zes zones (coÃ¶rdinaten van Chart.js)
                    
                    // Zone 1: Rood (Laagste Prioriteit: Low/Middel Conf, Slow TtV)
                    // Dit is het grootste rode gebied onderaan
                    drawZone('rgba(255, 0, 0, 0.25)', left, y_slow, x_mid_high, bottom); 

                    // Zone 2: Donker Oranje (Middel Conf, Middel TtV)
                    drawZone('rgba(255, 140, 0, 0.25)', x_low, top, x_mid_high, y_slow);

                    // Zone 3: Rood (Very Low Conf, Fast TtV)
                    drawZone('rgba(255, 0, 0, 0.25)', left, top, x_low, y_slow);

                    // Zone 4: Donkergroen (Hoogste Prioriteit: High Conf, Fast TtV)
                    drawZone('rgba(0, 150, 0, 0.25)', x_mid_high, top, right, y_mid);
                    
                    // Zone 5: Lichtgroen (Hoge Conf, Middel TtV)
                    drawZone('rgba(144, 238, 144, 0.25)', x_mid_high, y_mid, right, y_slow);

                    // Zone 6: Licht Oranje (High Conf, Slow TtV)
                    drawZone('rgba(255, 165, 0, 0.25)', x_mid_high, y_slow, right, bottom);

                    ctx.restore();
                }
            };
            
            // ====================================================
            // 2. Data preparation: Blijft ongewijzigd
            // ====================================================
            //kleur van bol aanpassen naar kwadrankt:
            function getZoneColor(confidence, ttv) {
                // Definieer de grenzen
                const x_low = 1;
                const x_high = 7;
                const y_slow = 5;
                const y_fast = 7;

                // 1. HIGH CONFIDENCE zones (X >= 7)
                if (confidence >= x_high) {
                    if (ttv >= y_fast) {
                        return 'rgba(0, 150, 0, 1)';      // Donkergroen (Zone 4: High Conf, Fast TtV)
                    } else if (ttv >= y_slow && ttv < y_fast) {
                        return 'rgba(144, 238, 144, 1)';  // Lichtgroen (Zone 5: High Conf, Middel TtV)
                    } else { // ttv < 5
                        return 'rgba(255, 165, 0, 1)';  // Licht Oranje (Zone 6: High Conf, Slow TtV)
                    }
                } 
                
                // 2. LOW/MIDDEL CONFIDENCE zones (X < 7)
                else {
                    // X < 7
                    if (ttv < y_slow) {
                        return 'rgba(255, 0, 0, 1)';      // Rood (Zone 1: Low/Middel Conf, Slow TtV)
                    } else { // ttv >= 5
                        if (confidence < x_low) {
                            return 'rgba(255, 0, 0, 1)';  // Rood (Zone 2.1: Very Low Conf, Fast/Middel TtV)
                        } else { // confidence >= 1 en < 7
                            return 'rgba(255, 140, 0, 1)'; // Donker Oranje (Zone 2.2: Middel Conf, Fast/Middel TtV)
                        }
                    }
                }
            }
            const datasets = [{
                label: 'Features',
                data: chartData.map(item => {
                    // ... (ROI/Radius berekening blijft hetzelfde)
                    const roiValue = item.roi; 
                    const radius = Math.max(5, Math.min(40, (Math.max(0, roiValue) / 10))); 
                    
                    const confidenceValue = item.confidence;
                    const ttvValue = item.ttv;
                    
                    // **NIEUW:** Bepaal de vulkleur op basis van de zonekleur
                    const zoneColor = getZoneColor(confidenceValue, ttvValue);

                    return {
                        x: confidenceValue, 
                        y: ttvValue, 
                        r: radius, 
                        name: item.name,
                        ttv: ttvValue,
                        roi: roiValue,
                        confidence: confidenceValue,
                        // Gebruik de zoneColor als de achtergrondkleur van de bubbel
                        backgroundColor: zoneColor
                    };
                }),
                // Bubbelkleur is nu de berekende zonekleur
                backgroundColor: (context) => context.raw.backgroundColor,
                
                // Zet de rand op zwart voor contrast
                borderColor: 'rgba(0, 0, 0, 1)', 
                borderWidth: 1
            }];

            // ====================================================
            // 3. Chart.js Initialization
            // ====================================================
            new Chart(ctx, {
                type: 'bubble',
                data: { datasets: datasets },
                plugins: [sixZonePlugin], 
                options: {
                    responsive: true,
                    maintainAspectRatio: true, 
                    aspectRatio: 1,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = context.raw;
                                    return [
                                        item.name, 
                                        `Confidence (X): ${item.confidence.toFixed(2)}`, 
                                        `TtV (Y): ${item.ttv.toFixed(0)} weeks`, 
                                        `ROI (Size): ${item.roi.toFixed(1)}%` 
                                    ];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'VECTR Prioritization: Confidence vs. Time-to-Value'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Confidence'
                            },
                            type: 'linear',
                            position: 'bottom',
                            min: 0, 
                            max: 10.0,
                            ticks: {
                                // Toon 'Low' bij 0,5 en 'High' bij 8
                                callback: function(value, index, ticks) {
                                    if (value === 1) return 'Low';
                                    if (value === 8) return 'High';
                                    if (value === 2 || value === 4|| value === 6|| value === 9) return '';
                                    return value;
                                }
                            },
                            grid: {
                                drawOnChartArea: false 
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Time-to-Value (TtV)'
                            },
                            type: 'linear',
                            min: 0, 
                            max: 10.0,
                            ticks: {
                                // Toon 'Fast' bij 8 en 'Slow' bij 3 
                                callback: function(value, index, ticks) {
                                    if (value === 8) return 'Fast';
                                    if (value === 2) return 'Slow'; 
                                    if (value === 4|| value === 6|| value === 9) return '';
                                    return value;
                                }
                            },
                            grid: {
                                drawOnChartArea: false 
                            }
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}