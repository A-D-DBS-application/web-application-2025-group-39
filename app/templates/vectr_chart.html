{% extends "base.html" %}

{% block title %}VECTR Prioritization: {{ project.project_name }}{% endblock %}

{% block content %}
    <h2 class="text-center mb-4">VECTR Prioritization Chart for {{ project.project_name }}</h2>
    
    <div class="top-right">
        <a href="{{ url_for('main.view_features', project_id=project.id_project) }}" 
        class="btn btn-base btn-nav btn-sm">
        Features Overview
        </a>
    </div>

    <div class="text-center">
        <a href="{{ url_for('main.add_feature', project_id=project.id_project) }}" 
           class="btn btn-base btn-primary-custom">
            + Add Feature
        </a>
    </div>

    <div id="chartData" style="display:none;">{{ chart_data | tojson }}</div>

    <div class="card shadow p-4 mx-auto vectr-card">
        <canvas id="vectrChart"></canvas>
        <p class="text-center mt-3 text-muted">
            X-axis: Confidence | Y-axis: TtV | Bubble Size: ROI (The bigger the bubble, the higher the ROI)
        </p>
    </div>

{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // This works now because the div with ID 'chartData' exists.
            const chartData = JSON.parse(document.getElementById("chartData").textContent);
            const ctx = document.getElementById('vectrChart').getContext('2d');
            
            // ====================================================
            // 1. Custom Plugin: VECTR Quadrants (Confidence vs. TtV)
            // ====================================================
            const quadrantPlugin = {
                id: 'quadrants',
                beforeDraw(chart, args, options) {
                    const { ctx, chartArea: { left, top, right, bottom }, scales: { x, y } } = chart;
                    ctx.save();
                    
                    // --- THRESHOLDS ---
                    const conf_middle_value = 1.0; 
                    const ttv_middle_value = 8;     

                    // Translate values to pixel coordinates
                    const xCenter = x.getPixelForValue(conf_middle_value);
                    const yCenter = y.getPixelForValue(ttv_middle_value);

                    const drawQuadrant = (color, x1, y1, x2, y2) => {
                        ctx.fillStyle = color;
                        ctx.fillRect(x1, y1, x2 - x1, y2 - y1);
                    };
                    
                    // Draw the 4 quadrants
                    drawQuadrant('rgba(0, 150, 0, 0.15)', xCenter, top, right, yCenter);      // Green
                    drawQuadrant('rgba(255, 255, 0, 0.15)', left, top, xCenter, yCenter);    // Yellow
                    drawQuadrant('rgba(255, 165, 0, 0.15)', xCenter, yCenter, right, bottom);// Orange
                    drawQuadrant('rgba(255, 0, 0, 0.15)', left, yCenter, xCenter, bottom);  // Red

                    ctx.restore();
                }
            };
            
            // ====================================================
            // 2. Data preparation: Assign VECTR values
            // ====================================================
            const datasets = [{
                label: 'Features',
                data: chartData.map(item => {
                    
                    const roiValue = item.roi; 
                    // Determine bubble size (r) based on ROI, scaled between 5 and 40
                    const radius = Math.max(5, Math.min(40, (Math.max(0, roiValue) / 10))); 
                    
                    const confidenceValue = item.confidence;
                    // Determine color based on Confidence
                    const colorIntensity = Math.min(255, 50 + confidenceValue * 60); 
                    const backgroundColor = `rgba(50, ${colorIntensity}, 50, 0.8)`; 

                    return {
                        x: confidenceValue, 
                        y: item.ttv, 
                        r: radius, 
                        name: item.name,
                        ttv: item.ttv,
                        roi: item.roi,
                        confidence: confidenceValue,
                        backgroundColor: backgroundColor
                    };
                }),
                backgroundColor: (context) => context.raw.backgroundColor,
                borderColor: 'rgba(0, 0, 0, 0.5)',
                borderWidth: 1
            }];

            // ====================================================
            // 3. Chart.js Initialization
            // ====================================================
            new Chart(ctx, {
                type: 'bubble',
                data: { datasets: datasets },
                plugins: [quadrantPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: true, 
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = context.raw;
                                    
                                    return [
                                        item.name, 
                                        `Confidence (X): ${item.confidence.toFixed(2)}`, 
                                        `TtV (Y): ${item.ttv.toFixed(0)} weeks`, 
                                        `ROI (Size): ${item.roi.toFixed(1)}%` 
                                    ];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'VECTR Prioritization: Confidence vs. Time-to-Value'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Confidence (Quality of Evidence - Higher is Better)'
                            },
                            type: 'linear',
                            position: 'bottom',
                            min: 0, 
                            max: 10.0, // Fixed scale for Confidence
                            grid: {
                                drawOnChartArea: false 
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Time-to-Value (TtV) in Weeks (Lower is Better)'
                            },
                            type: 'linear',
                            reverse: true, // Lower TtV (good) at the top
                            grid: {
                                drawOnChartArea: false 
                            }
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}