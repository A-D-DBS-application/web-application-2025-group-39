{% extends "base.html" %}

{% block title %}VECTR Prioritization: {{ project.project_name }}{% endblock %}

{% block content %}
    <h2 class="text-center mb-4">VECTR Prioritization Chart for {{ project.project_name }}</h2>
    <div class="card shadow p-4 mx-auto" style="max-width: 1200px;">
        <canvas id="vectrChart"></canvas>
        <p class="text-center mt-3 text-muted">Bubble Size: Time-to-Value (Lagere TtV = Kleinere, betere bubbel)</p>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chartData = {{ chart_data | tojson }}; 
            const ctx = document.getElementById('vectrChart').getContext('2d');
            
            // ====================================================
            // 1. Custom Plugin: VECTR Quadranten (Confidence vs. ROI)
            // ====================================================
            const quadrantPlugin = {
                id: 'quadrants',
                beforeDraw(chart, args, options) {
                    const { ctx, chartArea: { left, top, right, bottom }, scales: { x, y } } = chart;
                    ctx.save();
                    
                    // Grenswaarden voor de 4 kwadranten
                    const conf_middle_value = 1.0;  // Confidence 1.0 als grens
                    const roi_middle_value = 100;   // ROI 100% als grens

                    // Vertaal de waarden naar pixelcoÃ¶rdinaten
                    const xCenter = x.getPixelForValue(conf_middle_value);
                    const yCenter = y.getPixelForValue(roi_middle_value);

                    const drawQuadrant = (color, x1, y1, x2, y2) => {
                        ctx.fillStyle = color;
                        ctx.fillRect(x1, y1, x2 - x1, y2 - y1);
                    };
                    
                    // 1. Groen (Rechtsboven): Hoge ROI, Hoge Confidence (IDEALE FEATURES)
                    drawQuadrant('rgba(0, 150, 0, 0.15)', xCenter, top, right, yCenter);

                    // 2. Geel (Linksboven): Hoge ROI, Lage Confidence (VALIDATIE NODIG)
                    drawQuadrant('rgba(255, 255, 0, 0.15)', left, top, xCenter, yCenter);

                    // 3. Oranje (Rechtsonder): Lage ROI, Hoge Confidence (LAGERE PRIORITEIT)
                    drawQuadrant('rgba(255, 165, 0, 0.15)', xCenter, yCenter, right, bottom);

                    // 4. Rood (Linksonder): Lage ROI, Lage Confidence (TE VERMIJDEN)
                    drawQuadrant('rgba(255, 0, 0, 0.15)', left, yCenter, xCenter, bottom);

                    ctx.restore();
                }
            };
            
            // ====================================================
            // 2. Data voorbereiden: Toewijzen van VECTR-waarden
            // ====================================================
            const datasets = [{
                label: 'Features',
                data: chartData.map(item => {
                    
                    // Bubble Grootte (r): TtV (weeks). Hoe hoger TtV, hoe groter de bubbel.
                    const ttvValue = item.ttv; 
                    // Schaal: bij TtV 10 is de grootte 10. Max 30.
                    const radius = Math.max(5, Math.min(30, ttvValue)); 
                    
                    // Bubble Kleur (Optioneel): Kleur op basis van Confidence
                    const confidenceValue = item.confidence;
                    const colorIntensity = Math.min(255, 100 + confidenceValue * 40); 
                    const backgroundColor = `rgba(50, ${colorIntensity}, 50, 0.8)`; 

                    return {
                        x: confidenceValue, // X-as: Confidence
                        y: item.roi,        // Y-as: ROI (%)
                        r: radius,          // Grootte: TtV
                        name: item.name,
                        ttv: item.ttv,
                        roi: item.roi,
                        confidence: confidenceValue,
                        backgroundColor: backgroundColor
                    };
                }),
                backgroundColor: (context) => context.raw.backgroundColor,
                borderColor: 'rgba(0, 0, 0, 0.5)',
                borderWidth: 1
            }];

            // ====================================================
            // 3. Chart.js Initialisatie
            // ====================================================
            new Chart(ctx, {
                type: 'bubble',
                data: { datasets: datasets },
                plugins: [quadrantPlugin], // Registreer de quadrant plugin
                options: {
                    responsive: true,
                    maintainAspectRatio: true, 
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = context.raw;
                                    
                                    // Tooltip toont alle VECTR-waarden
                                    return [
                                        item.name, 
                                        `ROI: ${item.roi.toFixed(1)}%`,
                                        `Confidence: ${item.confidence.toFixed(2)}`, 
                                        `TtV: ${item.ttv.toFixed(0)} weken (Grootte)`
                                    ];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'VECTR Prioritization: Confidence vs. ROI'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Confidence (Kwaliteit van Bewijs)'
                            },
                            // Confidence: Hogere waarden rechts (standaard)
                            type: 'linear',
                            position: 'bottom',
                            min: 0, 
                            max: 3.0, // Aanname: max score is 3.0
                            grid: {
                                drawOnChartArea: false 
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Return on Investment (ROI) in %'
                            },
                            type: 'linear',
                            min: -50, // Laat toe om negatieve ROI te tonen
                            grid: {
                                drawOnChartArea: false 
                            }
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}